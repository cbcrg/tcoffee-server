#{extends 'layout.html' /}

#{set 'meta'}
<meta NAME="robots" CONTENT="NOFOLLOW" />
#{/set}

*{
 This page use the jquery autocomplete component. See 
 http://bassistance.de/jquery-plugins/jquery-plugin-autocomplete/ 
 https://github.com/agarzola/jQueryAutocompletePlugin
 http://docs.jquery.com/Plugins/Autocomplete/autocomplete#url_or_dataoptions
 }* 

#{set 'moreStyles'} 
<link href="@{'/public/fileuploader/fileuploader.css'}" rel="stylesheet" type="text/css" />
<link href="@{'/public/jquery.autocomplete.css'}" rel="stylesheet" type="text/css" />

<style type="text/css">

.field-wrap {
  padding-left: 3em; 
  padding-bottom: 1.5em
} 

.display-none { display: none; } 

#drop-box { 
	min-height: 3.5em;
	margin: 0em 2em 0em 3em;
} 


#uploaded-file-list {
	margin: auto 2em;
} 

.upload-progress {
	display:inline-block;
}

#error-message {
    width: 100%;
	text-align: center;
    position: absolute;
	left: 0;
	z-index: 99;
}
 
#error-message > span {
	width: 350px;
	margin: 0 auto;
	padding: 6px 10px;
    color: #D8000C;
	border: 1px solid;
	background-color: #FFBABA;
	-webkit-border-radius: 4px; 
	-moz-border-radius: 4px; 
	border-radius: 4px;
}

div.progress-container {
  border: 1px solid #ccc; 
  width: 100px; 
  margin: 2px 5px 2px 0; 
  padding: 1px; 
  float: left; 
  background: white;
  float: left;
  position: relative;
  top: 5px;
  
}

div.progress-container > div {
  background-color: #0084EF; 
  height: 12px;
}

/** Ajax Upload style **/

.qq-upload-list li {
	font-family: arial, sans-serif; 
	list-style-type: square;
	line-height: 1.5em;
	font-size: 18px;
} 

.qq-upload-fail {
	display: none;
} 

.qq-upload-size {
	color: #999;
	font-size: 12px;
} 

.qq-upload-file, 
.qq-upload-size { 
	margin-right: .8em;
}

.qq-upload-button {
	width: 15em;  
}

.qq-upload-button-hover { 

}
.qq-upload-button-focus { 

}

/** Autocomplete **/

.ac_results { 
	font-family: arial, sans-serif;
	text-align: left;
 }
.ac_results li { 
	font-family: arial, sans-serif;
	font-size: 17px;
	font-weight: 700;
	line-height: 28px;
	border: 1px solid white;
}
.ac_result li strong {
	font-size: 15px;
	font-weight: 400;
} 

.ac_odd {
	background-color: white;
}

.ac_over {
	background-color: #eee;
	border: 1px solid #ddd;
	color: black;
}
</style>
#{/set} 

#{set 'moreScripts'} 
<script src="@{'/public/javascripts/jquery.autocomplete.min.js'}" type="text/javascript" ></script>
<script src="@{'/public/javascripts/autocomplete-choices.js'}" type="text/javascript" ></script>
#{/set} 

<h1>T-Coffee advanced  
<small><span>${service.description}</span></small>
</h1>

<fieldset>
<h2><span>1. Upload your data</span>
<small><span>You can either click the below link or just drag your files here to upload them (drag&amp;drop works only using Chrome or Firefox)</span></small>
</h2>

<div id="error-message"  >
<span class="display-none"></span>
</div>

<div id="drop-box"></div>

<div>&nbsp;</div>
</fieldset>


<form id="form" action="@{Application.advanced}" method="POST" enctype="multipart/form-data">
<fieldset >
<h2><span>2. Enter the program options</span>
<small><span>Specify in the below field the T-Coffee options such as you the command line version of the program</span></small></h2>

<div class="field-wrap">
<textarea id="the-cmd-line" name="cmdline" style="width: 55em; height: 4.5em">${service.input.fields().get(0).value}</textarea>
<span class="c-error">#{error 'cmdline' /}</span>

<div style="margin-right: 3.5em">
<small >
You can enter any valid T-coffee command line options, 
for example <code>-in your_input_file.fasta -mode expresso -output score_html fasta_aln</code>. 

You can find an introduction to command line options and syntax at the following <a href="http://sites.google.com/site/tcoffeetutorials/" target="_blank" >T-Coffee tutorial</a>.

Also it may be useful the following <a href="http://www.tcoffee.org/Documentation/t_coffee/t_coffee_tutorial.htm#_Toc235985428" target="_blank">T-Coffee Cheat Sheat</a> and 
<a href="http://www.tcoffee.org/Documentation/t_coffee/t_coffee_technical.htm#_Toc256781607" target="_blank">T-Coffee reference manual</a>.</small>
</div>
</div>
</fieldset>


<fieldset >
<h2><span>3. Email address</span>
<small><span>Specify your email address if your want to be notified on alignment completion (optional)</span></small></h2>

<div class="field-wrap">
<input type="text" name="email" >
<span class="c-error">#{error 'email' /}</span>
</div>
</fieldset>

<div class="field-wrap">
<button id="submit" type="submit" class="button blue" >Submit</button>&nbsp;&nbsp;&nbsp;<a id="reset" href="javascript:void(0)" title="Reset the form to default values">Reset</a>
</div>
</form>

*{ 
   Ajax file uploader 
   See http://valums.com/ajax-upload/  
  }*
<script src="@{'/public/fileuploader/fileuploader.js'}" type="text/javascript" ></script> 

<script type="text/javascript">

$(document).ready(function(){

	/* remove any error message if the input change */
	$('.field-wrap input, .field-wrap textarea')
		.bind('clearErrors', function() { 
				$(this).parents('.field-wrap').find('.c-error').remove(); 
			})
		.change(function(){ $(this).trigger('clearErrors') });

	/* 
	 * AJax Upload Component
	 */
	new qq.FileUploader({
	    // pass the dom node (ex. $(selector)[0] for jQuery users)
	    element: document.getElementById('drop-box'),

	    // path to server-side upload script
	    action: '@{Data.ajaxupload}',
	    sizeLimit: 1024*1024*20, // <-- max 20 MB input files
	    multiple: true,

        template: 
       		'<div class="qq-uploader">' + 
		        '<div class="qq-upload-drop-area"><span>Drop files here to upload</span></div>' +
		        '<div class="qq-upload-button"><span>Click or drag your files here</span></div>' +
		        '<ul class="qq-upload-list"></ul>' + 
	     	'</div>',

        // template for one item in file list
        fileTemplate: 
            '<li>' +
                '<span class="qq-upload-file"></span>' +
                '<div class="upload-progress"><div class="progress-container" ><div style="width:0%"></div></div> <div style="clear:both"></div> </div> ' +
                '<span class="qq-upload-size"></span>' +
                '<a class="qq-upload-cancel" href="#">Cancel</a>' +
                '<span class="qq-upload-failed-text">Failed</span>' +
            '</li>',     

	   classes: {
	       // used to get elements from templates
	       button: 'qq-upload-button',
	       drop: 'qq-upload-drop-area',
	       dropActive: 'qq-upload-drop-area-active',
	       list: 'qq-upload-list',
	                   
	       file: 'qq-upload-file',
	       spinner: 'upload-progress',
	       size: 'qq-upload-size',
	       cancel: 'qq-upload-cancel',
	
	       // added to list item when upload completes
	       // used in css to hide progress spinner
	       success: 'qq-upload-success',
	       fail: 'qq-upload-fail'
	   },

       // return false to cancel submit
       onSubmit: function(id, fileName) {  
			$('#error-message > span').hide()
	   },

       onProgress: function(id, fileName, loaded, total){ 
           var percent = Math.floor(loaded / total * 100); 
           $('div.progress-container > div').css('width', ''+percent+'%')
       },

       onCancel: function(id, fileName){ },
	   
	   onComplete: function(id, fileName, response){
    	   $('#upload-progress').hide();
    	   
    	   if( !response.success ) {
				return false;
		   }

		   /* The array 'autocompleteChoices' is defined by the script 'autocomplete-choices.js' */
		   /* Adding the auploaded file in the array are re-populate the autocomplete control */
		   autocompleteChoices.push(fileName);
		   var options = {data: autocompleteChoices}
		   /* if the command line field is empty, add the uploaded file as default input sequence */
		   $('#the-cmd-line').trigger("setOptions", [options]);
		   $('#the-cmd-line').focus()
			if( $('#the-cmd-line').val() == '' ) {
				$('#the-cmd-line').val("-seq " + fileName)
			}
		},
		
		// display error message 
        showMessage: function(message){
			$('#error-message > span').show().text(message + " File has not been uploaded.");
			setTimeout( function() { $('#error-message > span').fadeOut() }, 5000 );
        }               
			    

	});

/* append to the list the files that have been already uploaded  */
#{list uploadFileList }	
#{if _?.path?.exists()}
	var item = '<span class="qq-upload-file">${_?.fileName}</span>' + 
		       '<span class="qq-upload-size" style="display: inline;">${_?.path?.length().formatSize()}</span>';
	$('#drop-box .qq-upload-list').append('<li class="qq-upload-success">'+item+'</li>')
	
	autocompleteChoices.push('${_?.fileName?.escapeJavaScript()}');
#{/if}
#{/list}

	/* 
	 * Create the autocomplete component 
	 */  

	$('#the-cmd-line').autocomplete(autocompleteChoices, {
			delay: 750,
			max: 100,
			multiple: true,
			multipleSeparator: ' ',
			mustMatch: false,
			autoFill: true
		});
		

});

/* 
 * disabling submit button on first click
 */
$('#form').submit(function(){
	$('#submit').attr('disabled',true).addClass('disabled').text('Wait ...');

});

$(document).ready(function(){
	$('#submit').removeAttr('disabled').removeClass('disabled').text('Submit');
});

/* 
 * Extra logic to reset the form fields 
 */
$('#reset').click(function() { $('#form')[0].reset(); $('textarea').each(function(){ $(this).text(''); $(this).trigger('clearErrors'); $(this).trigger('keydown'); } ) } )

/* hack to avoid content cache that will prevent ready execution on back-button for firefox */
$(window).unload(function(){ return void(0) });

</script>
